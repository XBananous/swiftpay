<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SwiftPay — Compte bancaire</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <style>
    body { background:#f8f9fa; -webkit-font-smoothing:antialiased; }
    .card-section { border-radius:12px; }
    .balance-big { font-size:2.25rem; font-weight:700; }
    .small-note { font-size:.85rem; color:#6c757d; }
    #loading-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.8); z-index:2200000000; display:none; align-items:center; justify-content:center; }
    .transaction-type-credit { color:#0d6efd; font-weight:700; }
    .transaction-type-debit { color:#dc3545; font-weight:700; }
    .status-completed { background:#e7f3ff; color:#0b5ed7; padding:.25rem .5rem; border-radius:8px; font-weight:700; }
    #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 2250000000; display:flex; flex-direction:column; gap:.5rem; max-width:360px; }
    .db-warning { border-left:4px solid #ffc107; background:#fff8e1; padding:.75rem; border-radius:8px; }
    .iban-input-group .form-control[readonly] { background-color:#fff; }
    .btn-copy { min-width:3.25rem; }
    .btn-send { min-width:160px; }
    .filters-row { gap:.5rem; display:flex; align-items:center; margin-bottom:.75rem; }
    .scheduled-list { max-height:220px; overflow:auto; }
    .upcoming-balance { font-weight:700; }
    @media (max-width:576px){ .balance-big{ font-size:1.6rem } .filters-row{ flex-direction:column; align-items:stretch } }
  </style>
</head>
<body>

  <nav class="navbar navbar-light bg-white shadow-sm">
    <div class="container d-flex align-items-center justify-content-between">
      <div>
        <button id="nav-back-btn" class="btn btn-outline-secondary btn-sm" title="Retour">
          <i class="fa-solid fa-arrow-left"></i>
        </button>
      </div>
      <div class="d-flex align-items-center gap-2">
        <a class="navbar-brand mb-0 h1 d-flex align-items-center" href="index.html" title="SwiftPay">
          <img src="logo.png" alt="logo" width="36" height="36">
        </a>
      </div>
    </div>
  </nav>

  <div id="loading-overlay" aria-hidden="true">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status" style="width:4rem;height:4rem"></div>
      <div class="fw-semibold mt-3" id="loading-text">Chargement...</div>
    </div>
  </div>

  <main class="container py-4">
    <div id="db-unavailable-banner" class="db-warning mb-3 d-none">
      <strong>Base de données inaccessible — virement impossible.</strong>
      <div class="small-note">Les opérations d'envoi sont désactivées tant que la connexion n'est pas rétablie.</div>
    </div>

    <div class="row g-3">

      <!-- Compte -->
      <div class="col-12 col-md-7">
        <div class="card card-section p-3">
          <div class="d-flex gap-3 align-items-start">
            <div style="width:64px;height:64px;border-radius:12px;overflow:hidden;">
              <img id="acct-avatar" src="https://upload.wikimedia.org/wikipedia/commons/5/59/Discord_logo_2015.svg" style="width:100%;height:100%;object-fit:cover">
            </div>
            <div class="flex-grow-1">
              <div class="fw-semibold" id="acct-username">Non connecté</div>
              <div class="small text-muted" id="acct-userid"></div>
              <div class="small text-muted mt-1" id="acct-company"></div>
            </div>
            <div class="text-end">
              <button id="btn-refresh-account-right" class="btn btn-outline-secondary btn-sm" title="Actualiser"><i class="fa-solid fa-arrows-rotate"></i></button>
            </div>
          </div>

          <hr>

          <div class="mt-2">
            <div class="fw-semibold small mb-1">IBAN (ton compte)</div>
            <div class="input-group iban-input-group">
              <input id="acct-iban" class="form-control form-control-sm" readonly>
              <button id="btn-copy-iban" class="btn btn-outline-primary btn-copy" title="Copier l'IBAN"><i class="fa-regular fa-copy"></i></button>
            </div>
            <div class="small-note mt-2">IBAN = <code>EU</code> + ID Discord complet (ex: <code>EU123456789012345678</code>).</div>
          </div>
        </div>
      </div>

      <!-- Solde et Solde à venir -->
      <div class="col-12 col-md-5">
        <div class="card card-section p-3">
          <div class="text-end">
            <div class="small-note">Solde courant</div>
            <div class="balance-big" id="balance-current">0.00 €</div>
            <div class="small-note mt-2" id="balance-updated">Dernière synchronisation : —</div>
            <hr>
            <div class="small-note">Solde à venir</div>
            <div class="upcoming-balance" id="balance-upcoming">0.00 €</div>
          </div>
        </div>
      </div>

      <!-- Actions (Envoyer en haut) -->
      <div class="col-12 col-md-6">
        <div class="card card-section p-3 h-100">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <div class="fw-semibold">Actions</div>
              <div class="small-note mt-1">Opérations disponibles</div>
            </div>
          </div>

          <!-- Envoyer placé ici, en premier -->
          <div class="mb-3">
            <button id="btn-send-transfer" class="btn btn-primary btn-send w-100"><i class="fa-solid fa-arrow-right-from-bracket me-2"></i>Envoyer un virement</button>
          </div>

          <hr>

          <div class="d-grid gap-2">
            <a id="btn-payment-methods" class="btn btn-outline-primary" href="payement_methods.html"><i class="fa-solid fa-credit-card me-2"></i>Gérer moyens de paiement</a>
            <button id="btn-repeat-last" class="btn btn-outline-secondary"><i class="fa-solid fa-list me-2"></i>Modèles de virements</button>
            <button id="btn-view-history" class="btn btn-outline-secondary"><i class="fa-solid fa-list me-2"></i>Voir l'historique complet</button>
            <button id="btn-manage-scheduled" class="btn btn-outline-secondary"><i class="fa-regular fa-clock me-2"></i>Gérer virements programmés</button>
          </div>
        </div>
      </div>

      <!-- Historique récent + filtres -->
      <div class="col-12 col-md-6">
        <div class="card card-section p-3 h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">Historique récent</div>
            <div class="small-note">Dernières transactions</div>
          </div>

          <!-- Filters -->
          <div class="filters-row mb-2">
            <select id="tx-filter-type" class="form-select form-select-sm" style="max-width:160px;">
              <option value="all">Tous</option>
              <option value="debit">Débit</option>
              <option value="credit">Crédit</option>
            </select>
            <input id="tx-filter-q" class="form-control form-control-sm" placeholder="Rechercher IBAN ou libellé" />
            <button id="tx-filter-clear" class="btn btn-sm btn-outline-secondary">Effacer</button>
          </div>

          <div id="transactions-list" style="max-height:420px;overflow:auto;"></div>
        </div>
      </div>

      <!-- Scheduled quick view -->
      <div class="col-12">
        <div class="card card-section p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">Virements programmés</div>
            <div class="small-note">Ils s’affichent ici et sont inclus dans le solde à venir.</div>
          </div>
          <div id="scheduled-quick" class="scheduled-list"></div>
        </div>
      </div>

    </div>
  </main>

  <!-- MODAL : Send transfer (ajout option programmer + sauvegarder comme modèle) -->
  <div class="modal fade" id="transferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form id="transfer-form" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Envoyer un virement</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="transfer-error" class="alert alert-danger d-none"></div>

          <div class="mb-3">
            <label class="form-label">Montant (€)</label>
            <input id="transfer-amount" type="number" step="0.01" min="0.01" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">IBAN destinataire</label>
            <input id="transfer-iban" class="form-control" placeholder="EU + ID Discord complet (ex: EU123...)" required>
            <div class="form-text small-note">L'IBAN doit correspondre exactement à un compte enregistré.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Libellé</label>
            <input id="transfer-desc" class="form-control" placeholder="Ex : Paiement fournisseur / salaire">
          </div>

          <div class="mb-3 form-check">
            <input class="form-check-input" type="checkbox" id="transfer-schedule">
            <label class="form-check-label" for="transfer-schedule">Programmer ce virement</label>
          </div>

          <div id="schedule-controls" class="d-none">
            <div class="mb-3">
              <label class="form-label">Date et heure d'envoi</label>
              <input id="transfer-date" type="datetime-local" class="form-control">
              <div class="form-text small-note">Le virement sera envoyé automatiquement à la date choisie (si tu es sur le site) sinon lors de ta prochaine visite.</div>
            </div>
          </div>

          <div class="mb-3 form-check">
            <input class="form-check-input" type="checkbox" id="transfer-save-template">
            <label class="form-check-label" for="transfer-save-template">Enregistrer comme modèle</label>
          </div>
          <div id="template-name-row" class="mb-3 d-none">
            <label class="form-label">Nom du modèle</label>
            <input id="template-name" class="form-control" placeholder="Ex : Loyer mensuel">
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary" id="transfer-submit">Confirmer le virement</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: models (templates) -->
  <div class="modal fade" id="templatesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Modèles de virements</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="templates-list"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Modal: manage scheduled transfers -->
  <div class="modal fade" id="scheduledModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Virements programmés - gestion</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="scheduled-list"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Modal: all transactions (lecture seule) -->
  <div class="modal fade" id="transactionsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Historique complet</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div id="transactions-full-list"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button></div>
      </div>
    </div>
  </div>

  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function(){
    // ----- config -----
    const SUPABASE_URL = "https://hqpewmimnllbjowvbljm.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxcGV3bWltbmxsYmpvd3ZibGptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDYzNzUsImV4cCI6MjA3NTUyMjM3NX0.BEdZuFYnJP7_14GFA8pYYq-gXRewphM49QP5NRWWHso";

    // ----- UI helpers -----
    const toastContainer = document.getElementById('toast-container');
    function showToast(text,type='primary',ttl=3500){
      const el = document.createElement('div');
      el.className = `toast align-items-center text-bg-${type} border-0 show`;
      el.style.marginBottom = '.5rem';
      el.innerHTML = `<div class="d-flex"><div class="toast-body">${text}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      toastContainer.prepend(el);
      setTimeout(()=> el.remove(), ttl);
    }
    function showLoading(msg="Chargement..."){ document.getElementById('loading-text').textContent = msg; document.getElementById('loading-overlay').style.display = 'flex'; }
    function hideLoading(){ document.getElementById('loading-overlay').style.display = 'none'; }
    function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }

    // ----- token / discord -----
    function getDiscordToken(){ return localStorage.getItem('access_token_demo') || null; }
    async function fetchDiscordUser(){
      const token = getDiscordToken();
      if(!token) throw new Error('no-token');
      const r = await fetch('https://discord.com/api/users/@me', { headers: { Authorization: `Bearer ${token}` }});
      if(!r.ok) throw new Error('discord-fetch-failed');
      return r.json();
    }

    // ----- supabase init -----
    let supabase = null;
    try {
      if(window.supabase && typeof window.supabase.createClient === 'function'){
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase ready');
      } else { supabase = null; console.warn('Supabase UMD not available'); }
    } catch(e){ supabase = null; console.error(e); }

    let dbAvailable = !!supabase;
    let currentUser = null;
    let account = null;
    let transactions = [];

    // ----- scheduled transfers (stored client-side) -----
    const SCHED_KEY = 'swiftpay_scheduled_transfers_v1';
    function loadScheduled(){ try { return JSON.parse(localStorage.getItem(SCHED_KEY) || '[]'); } catch { return []; } }
    function saveScheduled(arr){ localStorage.setItem(SCHED_KEY, JSON.stringify(arr || [])); }
    function formatDateLocal(ts){ try { return new Date(ts).toLocaleString(); } catch { return ts; } }

    // ----- templates (saved in Supabase "transfer_templates") -----
    async function loadTemplates(){
      if(!dbAvailable) return [];
      try {
        const { data, error } = await supabase.from('transfer_templates').select('*').eq('user_id', String(currentUser.id)).order('created_at', { ascending: false }).limit(200);
        if(error) { console.warn('loadTemplates error', error); return []; }
        return data || [];
      } catch(e){ console.warn('loadTemplates caught', e); return []; }
    }
    async function saveTemplate(obj){
      if(!dbAvailable) { showToast('Impossible d’enregistrer le modèle (base indisponible)','warning'); return false; }
      try {
        const rec = { user_id: String(currentUser.id), name: obj.name || '', amount: obj.amount || 0, iban: obj.iban || '', description: obj.description || '', created_at: new Date().toISOString() };
        const { error } = await supabase.from('transfer_templates').insert([rec]);
        if(error){ console.warn('saveTemplate error', error); showToast('Erreur enregistrement modèle','danger'); return false; }
        return true;
      } catch(e){ console.error('saveTemplate', e); showToast('Erreur enregistrement modèle','danger'); return false; }
    }

    // ----- util -----
    function computeIbanFromDiscordId(id){ return 'EU' + String(id); }

    // ----- account + transactions helpers (Supabase) -----
    async function ensureAccountExists(userId, userAvatar){
      if(!dbAvailable) throw new Error('db-unavailable');
      const { data, error } = await supabase.from('accounts').select('*').eq('user_id', String(userId)).limit(1).maybeSingle();
      if(error) throw error;
      if(data) return data;
      // create account (dev initial balance)
      const iban = computeIbanFromDiscordId(userId);
      const initialBalance = 1500.37;
      const { data: ins, error: errIns } = await supabase.from('accounts').insert([{ user_id: String(userId), balance: initialBalance, iban, avatar: userAvatar || null, created_at: new Date().toISOString() }]).select().maybeSingle();
      if(errIns) throw errIns;
      return ins;
    }

    async function loadTransactionsFromDB(userId){
      if(!dbAvailable) return [];
      const { data, error } = await supabase.from('transactions').select('*').eq('user_id', String(userId)).order('created_at', { ascending: false }).limit(500);
      if(error) throw error;
      return data || [];
    }

    // create account->account transfer (two tx + balances update)
    async function createAccountToAccountTransfer(amount, destIban, description){
      if(!dbAvailable){ showToast('Impossible : la base est inaccessible', 'danger'); return false; }
      if(!account) { showToast('Compte introuvable', 'danger'); return false; }
      amount = Number(Number(amount).toFixed(2));
      if(!amount || amount <= 0){ showToast('Montant invalide', 'warning'); return false; }

      showLoading('Traitement du virement...');
      try {
        const senderUserId = String(currentUser.id);
        const sourceAccount = account;
        const destIbanNorm = String(destIban || '').toUpperCase();

        // find recipient by IBAN exact match
        const { data: recipient, error: errRec } = await supabase.from('accounts').select('*').eq('iban', destIbanNorm).limit(1).maybeSingle();
        if(errRec) throw errRec;
        if(!recipient){ showToast('Compte destinataire introuvable', 'warning'); return false; }

        if(String(recipient.user_id) === String(senderUserId)){ showToast("Impossible : virement vers votre propre compte (interdit).", "warning"); return false; }
        if(Number(sourceAccount.balance) < amount){ showToast('Solde insuffisant', 'warning'); return false; }

        const txDebit = { user_id: senderUserId, type: 'debit', amount, status: 'completed', iban: destIbanNorm, description, created_at: new Date().toISOString() };
        const txCredit = { user_id: String(recipient.user_id), type: 'credit', amount, status: 'completed', iban: destIbanNorm, description, created_at: new Date().toISOString() };

        // insert txs
        const { data: insTx, error: errTx } = await supabase.from('transactions').insert([txDebit, txCredit]).select();
        if(errTx) throw errTx;

        // update balances
        const newSenderBalance = Number(sourceAccount.balance) - amount;
        const { error: errUpdSender } = await supabase.from('accounts').update({ balance: newSenderBalance }).eq('user_id', senderUserId);
        if(errUpdSender) throw errUpdSender;

        const newRecipientBalance = Number(recipient.balance) + amount;
        const { error: errUpdRec } = await supabase.from('accounts').update({ balance: newRecipientBalance }).eq('user_id', String(recipient.user_id));
        if(errUpdRec) throw errUpdRec;

        // refresh local state
        account = await ensureAccountExists(currentUser.id, currentUser.avatar);
        transactions = await loadTransactionsFromDB(currentUser.id);

        renderAccountUI();
        renderRecentTransactions();
        renderFullTransactions();

        showToast('Virement effectué (compte → compte)', 'success');
        return true;
      } catch(e){
        console.error('createAccountToAccountTransfer error', e);
        dbAvailable = false;
        document.getElementById('db-unavailable-banner').classList.remove('d-none');
        disableTransferControls(true);
        showToast('Erreur lors du traitement (base inaccessible ou erreur)', 'danger');
        return false;
      } finally { hideLoading(); }
    }

    // ----- scheduled transfers logic -----
    // scheduled item structure:
    // { id, user_id, amount, iban, description, send_at_iso, created_at_iso, attempts }
    function getScheduled(){ return loadScheduled(); }
    function setScheduled(arr){ saveScheduled(arr); renderScheduledQuick(); computeAndRenderUpcomingBalance(); }

    function addScheduled(item){
      const arr = getScheduled();
      item.id = 'sched_' + Date.now() + '_' + (Math.random().toString(36).slice(2,9));
      item.created_at = new Date().toISOString();
      item.attempts = 0;
      arr.push(item);
      setScheduled(arr);
      showToast('Virement programmé enregistré', 'primary');
    }

    function removeScheduledById(id){
      const arr = getScheduled().filter(x => x.id !== id);
      setScheduled(arr);
    }

    async function processDueScheduled(){
      if(!dbAvailable) return; // send only if DB available
      const now = new Date();
      const arr = getScheduled();
      let modified = false;
      for(const s of [...arr]){
        try {
          const sendAt = new Date(s.send_at);
          if(sendAt <= now){
            // attempt transfer
            const ok = await createAccountToAccountTransfer(Number(s.amount), s.iban, s.description || ('Virement programmé: ' + (s.template_name || '')));
            if(ok){
              // remove
              removeScheduledById(s.id);
              modified = true;
            } else {
              // increment attempts; keep
              s.attempts = (s.attempts || 0) + 1;
            }
          }
        } catch(e){
          console.warn('processDueScheduled item error', e);
          s.attempts = (s.attempts || 0) + 1;
        }
      }
      if(modified) {
        // state refreshed by createAccountToAccountTransfer
      }
    }

    // schedule checker runs at init + every 60s
    let scheduledInterval = null;
    function startScheduledChecker(){
      if(scheduledInterval) clearInterval(scheduledInterval);
      scheduledInterval = setInterval(()=> {
        // try to process due scheduled transfers
        if(dbAvailable) processDueScheduled();
      }, 60 * 1000);
    }

    // ----- UI rendering: scheduled -----
    function renderScheduledQuick(){
      const container = document.getElementById('scheduled-quick');
      const arr = getScheduled().sort((a,b)=> new Date(a.send_at) - new Date(b.send_at));
      if(!arr || arr.length === 0){ container.innerHTML = '<div class="small-note">Aucun virement programmé.</div>'; return; }
      container.innerHTML = '';
      arr.slice(0,6).forEach(s => {
        const el = document.createElement('div');
        el.className = 'd-flex justify-content-between align-items-start gap-2 mb-2';
        el.innerHTML = `<div><strong>${escapeHtml(s.description || 'Virement programmé')}</strong><div class="small text-muted">${formatDateLocal(s.send_at)}</div><div class="small text-muted">IBAN: ${escapeHtml(s.iban)}</div></div>
                        <div class="text-end"><div>${Number(s.amount).toFixed(2)} €</div></div>`;
        container.appendChild(el);
      });
    }

    function renderScheduledListModal(){
      const container = document.getElementById('scheduled-list');
      const arr = getScheduled().sort((a,b)=> new Date(a.send_at) - new Date(b.send_at));
      container.innerHTML = '';
      if(arr.length === 0){ container.innerHTML = '<div class="small-note">Aucun virement programmé.</div>'; return; }
      arr.forEach(s => {
        const card = document.createElement('div');
        card.className = 'card mb-2 p-2';
        card.innerHTML = `<div class="d-flex justify-content-between">
          <div>
            <div><strong>${escapeHtml(s.description || 'Virement programmé')}</strong></div>
            <div class="small text-muted">${formatDateLocal(s.send_at)}</div>
            <div class="small text-muted">IBAN: ${escapeHtml(s.iban)}</div>
          </div>
          <div class="text-end">
            <div class="fw-semibold">${Number(s.amount).toFixed(2)} €</div>
            <div class="small text-muted">Tentatives: ${s.attempts || 0}</div>
            <div class="mt-2">
              <button class="btn btn-sm btn-outline-primary btn-edit-sched">Éditer</button>
              <button class="btn btn-sm btn-outline-danger btn-del-sched">Supprimer</button>
            </div>
          </div>
        </div>`;
        // edit handler
        card.querySelector('.btn-edit-sched').addEventListener('click', ()=>{
          // prefill transfer modal with scheduled details for editing
          document.getElementById('transfer-amount').value = Number(s.amount).toFixed(2);
          document.getElementById('transfer-iban').value = s.iban;
          document.getElementById('transfer-desc').value = s.description || '';
          document.getElementById('transfer-schedule').checked = true;
          document.getElementById('schedule-controls').classList.remove('d-none');
          // fill date
          const dt = new Date(s.send_at);
          // format to yyyy-mm-ddThh:mm
          const localISO = dt.toISOString().slice(0,16);
          document.getElementById('transfer-date').value = localISO;
          // when saving, remove old scheduled and add new
          // store id in a temporary field
          document.getElementById('transfer-form').dataset.editingScheduledId = s.id;
          new bootstrap.Modal(document.getElementById('transferModal')).show();
        });
        // delete handler
        card.querySelector('.btn-del-sched').addEventListener('click', async ()=>{
          const ok = confirm('Supprimer ce virement programmé ?');
          if(!ok) return;
          removeScheduledById(s.id);
          renderScheduledListModal();
          renderScheduledQuick();
          computeAndRenderUpcomingBalance();
        });
        container.appendChild(card);
      });
    }

    // ----- upcoming balance computation -----
    function computeAndRenderUpcomingBalance(){
      const base = Number(account?.balance || 0);
      const arr = getScheduled();
      // sum scheduled amounts affecting the current user (we are the sender for scheduled items)
      const now = new Date();
      // include all scheduled transfers regardless of date (user wanted upcoming to include programmés)
      const totalScheduledEffect = arr.reduce((acc, s)=>{
        // scheduled from current user are outgoing => subtract
        if(String(s.user_id) === String(currentUser?.id)){
          return acc - Number(s.amount || 0);
        }
        return acc;
      }, 0);
      const upcoming = Number(base + totalScheduledEffect);
      document.getElementById('balance-upcoming').textContent = upcoming.toFixed(2) + ' €';
    }

    // ----- templates UI -----
    async function renderTemplatesModal(){
      const listEl = document.getElementById('templates-list');
      listEl.innerHTML = '';
      const templates = await loadTemplates();
      if(!templates || templates.length === 0){ listEl.innerHTML = '<div class="small-note">Aucun modèle enregistré.</div>'; return; }
      templates.forEach(t => {
        const card = document.createElement('div');
        card.className = 'card mb-2 p-2';
        card.innerHTML = `<div class="d-flex justify-content-between">
          <div>
            <div><strong>${escapeHtml(t.name || '(sans nom)')}</strong></div>
            <div class="small text-muted">IBAN: ${escapeHtml(t.iban || '')} — ${Number(t.amount||0).toFixed(2)} €</div>
            <div class="small text-muted">${escapeHtml(t.description || '')}</div>
          </div>
          <div class="text-end">
            <div class="d-flex flex-column align-items-end gap-2">
              <button class="btn btn-sm btn-outline-primary btn-use-template">Utiliser</button>
            </div>
          </div>
        </div>`;
        card.querySelector('.btn-use-template').addEventListener('click', ()=>{
          document.getElementById('transfer-amount').value = Number(t.amount||0).toFixed(2);
          document.getElementById('transfer-iban').value = t.iban || '';
          document.getElementById('transfer-desc').value = t.description || '';
          new bootstrap.Modal(document.getElementById('transferModal')).show();
          const bs = bootstrap.Modal.getInstance(document.getElementById('templatesModal'));
          if(bs) bs.hide();
        });
        listEl.appendChild(card);
      });
    }

    // ----- rendering transactions -----
    function applyTxFilters(list){
      const type = document.getElementById('tx-filter-type').value;
      const q = document.getElementById('tx-filter-q').value.trim().toLowerCase();
      return list.filter(tx=>{
        if(type !== 'all' && tx.type !== type) return false;
        if(q){
          if((tx.iban || '').toLowerCase().includes(q)) return true;
          if((tx.description || '').toLowerCase().includes(q)) return true;
          return false;
        }
        return true;
      });
    }

    function renderRecentTransactions(){
      const container = document.getElementById('transactions-list');
      container.innerHTML = '';
      const filtered = applyTxFilters(transactions);
      if(!filtered || filtered.length === 0){
        container.innerHTML = '<div class="small-note">Aucune transaction.</div>'; return;
      }
      const recent = filtered.slice(0,8);
      recent.forEach(tx=>{
        const div = document.createElement('div');
        div.className = 'd-flex justify-content-between align-items-start gap-2 mb-2';
        const left = document.createElement('div');
        left.innerHTML = `<div><strong>${escapeHtml(tx.description || (tx.type === 'credit' ? 'Crédit' : 'Débit'))}</strong></div>
                          <div class="small text-muted">${new Date(tx.created_at || Date.now()).toLocaleString()}</div>
                          <div class="small text-muted">IBAN: ${escapeHtml(tx.iban || '—')}</div>`;
        const right = document.createElement('div');
        const amt = (tx.type === 'credit' ? '+' : '-') + Number(tx.amount || 0).toFixed(2) + ' €';
        const amtSpan = document.createElement('div');
        amtSpan.innerText = amt;
        amtSpan.className = (tx.type === 'credit') ? 'transaction-type-credit' : 'transaction-type-debit';
        const statusSpan = document.createElement('div');
        statusSpan.className = 'status-completed mt-2';
        statusSpan.textContent = 'Terminé';
        right.appendChild(amtSpan);
        right.appendChild(statusSpan);
        div.appendChild(left);
        div.appendChild(right);
        container.appendChild(div);
      });
    }

    function renderFullTransactions(){
      const container = document.getElementById('transactions-full-list');
      container.innerHTML = '';
      const filtered = applyTxFilters(transactions);
      if(!filtered || filtered.length === 0){ container.innerHTML = '<div class="small-note">Aucune transaction.</div>'; return; }
      filtered.forEach(tx=>{
        const el = document.createElement('div');
        el.className = 'card mb-2 p-2';
        el.innerHTML = `<div class="d-flex justify-content-between">
          <div>
            <div><strong>${escapeHtml(tx.description || (tx.type === 'credit' ? 'Crédit' : 'Débit'))}</strong></div>
            <div class="small text-muted">${new Date(tx.created_at || Date.now()).toLocaleString()}</div>
            <div class="small text-muted">IBAN destinataire: ${escapeHtml(tx.iban || '—')}</div>
          </div>
          <div class="text-end">
            <div class="${tx.type==='credit' ? 'transaction-type-credit' : 'transaction-type-debit'}">${tx.type==='credit' ? '+' : '-'}${Number(tx.amount||0).toFixed(2)} €</div>
            <div class="status-completed mt-2">Terminé</div>
          </div>
        </div>`;
        container.appendChild(el);
      });
    }

    // ----- helpers UI -----
    function disableTransferControls(disabled){
      document.getElementById('btn-send-transfer').disabled = !!disabled;
      document.getElementById('btn-payment-methods').disabled = !!disabled;
      document.getElementById('transfer-submit').disabled = !!disabled;
      document.getElementById('btn-repeat-last').disabled = !!disabled;
      document.getElementById('btn-manage-scheduled').disabled = !!disabled;
    }

    // ----- init -----
    async function init(){
      showLoading('Vérification compte...');
      try { currentUser = await fetchDiscordUser(); } catch(e){ console.error(e); setTimeout(()=> location.href = 'login.html', 200); return; }

      if(!supabase){ dbAvailable = false; document.getElementById('db-unavailable-banner').classList.remove('d-none'); disableTransferControls(true); account = { user_id: String(currentUser.id), balance: 0, iban: computeIbanFromDiscordId(currentUser.id) }; transactions = []; renderAccountUI(); renderRecentTransactions(); renderScheduledQuick(); computeAndRenderUpcomingBalance(); hideLoading(); return; }

      try {
        account = await ensureAccountExists(currentUser.id, currentUser.avatar);
        transactions = await loadTransactionsFromDB(currentUser.id);
        dbAvailable = true;
        document.getElementById('db-unavailable-banner').classList.add('d-none');
        disableTransferControls(false);
      } catch(e){
        console.warn('DB ops failed', e);
        dbAvailable = false;
        document.getElementById('db-unavailable-banner').classList.remove('d-none');
        disableTransferControls(true);
        account = { user_id: String(currentUser.id), balance: 0, iban: computeIbanFromDiscordId(currentUser.id) };
        transactions = [];
      }

      // check scheduled items due now (and then every 60s)
      try { await processDueScheduled(); } catch(e){ console.warn('init processDueScheduled', e); }
      startScheduledChecker();

      renderAccountUI();
      renderRecentTransactions();
      renderScheduledQuick();
      computeAndRenderUpcomingBalance();
      hideLoading();
    }

    // ----- UI events -----
    document.getElementById('btn-send-transfer').addEventListener('click', ()=> {
      if(!dbAvailable){ showToast('Impossible : la base est inaccessible.', 'danger'); return; }
      // reset editingScheduledId marker
      delete document.getElementById('transfer-form').dataset.editingScheduledId;
      document.getElementById('transfer-amount').value = '';
      document.getElementById('transfer-iban').value = '';
      document.getElementById('transfer-desc').value = '';
      document.getElementById('transfer-schedule').checked = false;
      document.getElementById('schedule-controls').classList.add('d-none');
      document.getElementById('transfer-save-template').checked = false;
      document.getElementById('template-name-row').classList.add('d-none');
      new bootstrap.Modal(document.getElementById('transferModal')).show();
    });

    // templates modal
    document.getElementById('btn-repeat-last').addEventListener('click', async ()=>{
      if(!dbAvailable){ showToast('Impossible : la base est inaccessible.', 'danger'); return; }
      await renderTemplatesModal();
      new bootstrap.Modal(document.getElementById('templatesModal')).show();
    });

    document.getElementById('btn-view-history').addEventListener('click', ()=> { renderFullTransactions(); new bootstrap.Modal(document.getElementById('transactionsModal')).show(); });

    document.getElementById('btn-refresh-account-right').addEventListener('click', async ()=> { showLoading('Actualisation...'); await init(); hideLoading(); showToast('Actualisé', 'primary'); });

    document.getElementById('transfer-schedule').addEventListener('change', (ev)=> {
      const checked = ev.target.checked;
      document.getElementById('schedule-controls').classList.toggle('d-none', !checked);
    });

    document.getElementById('transfer-save-template').addEventListener('change', (ev)=> {
      const checked = ev.target.checked;
      document.getElementById('template-name-row').classList.toggle('d-none', !checked);
    });

    document.getElementById('btn-manage-scheduled').addEventListener('click', ()=> {
      renderScheduledListModal();
      new bootstrap.Modal(document.getElementById('scheduledModal')).show();
    });

    // submit transfer (immediate or scheduled)
    document.getElementById('transfer-form').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const amount = parseFloat(document.getElementById('transfer-amount').value);
      const iban = document.getElementById('transfer-iban').value.trim().toUpperCase();
      const desc = document.getElementById('transfer-desc').value.trim() || 'Virement';
      const isScheduled = document.getElementById('transfer-schedule').checked;
      const sendAtVal = document.getElementById('transfer-date').value;
      const saveTemplateChecked = document.getElementById('transfer-save-template').checked;
      const templateName = document.getElementById('template-name').value.trim();

      if(!amount || amount <= 0){ showToast('Montant invalide', 'warning'); return; }
      if(!/^EU\d+$/.test(iban)){ showToast('IBAN invalide — format attendu EU + ID Discord complet', 'warning'); return; }
      if(!dbAvailable){ showToast('Impossible : la base de données est inaccessible.', 'danger'); return; }

      // If saving template, attempt to save async (non-blocking)
      if(saveTemplateChecked){
        if(!templateName){ showToast('Donne un nom au modèle', 'warning'); return; }
        saveTemplate({ name: templateName, amount, iban, description: desc }).then(ok=> { if(ok) showToast('Modèle enregistré','primary'); });
      }

      // if editing an existing scheduled: remove old then add new
      const editingSchedId = document.getElementById('transfer-form').dataset.editingScheduledId;

      if(isScheduled){
        if(!sendAtVal){ showToast('Choisis la date/heure', 'warning'); return; }
        const sendAt = new Date(sendAtVal);
        if(isNaN(sendAt.getTime())){ showToast('Date invalide', 'warning'); return; }
        // create scheduled record (user is current user)
        const sched = { user_id: String(currentUser.id), amount: Number(amount.toFixed(2)), iban, description: desc, send_at: sendAt.toISOString(), template_name: templateName || '' };
        if(editingSchedId){
          // replace existing
          let arr = getScheduled().filter(x => x.id !== editingSchedId);
          arr.push(Object.assign({}, sched, { id: 'sched_' + Date.now(), created_at: new Date().toISOString(), attempts:0 }));
          setScheduled(arr);
        } else {
          addScheduled(sched);
        }
        // close modal
        const m = bootstrap.Modal.getInstance(document.getElementById('transferModal'));
        if(m) m.hide();
        // refresh scheduled UI & upcoming balance
        renderScheduledQuick();
        computeAndRenderUpcomingBalance();
        return;
      }

      // immediate transfer -> check and execute
      const okConfirm = await confirm(`Confirmer le virement de ${amount.toFixed(2)} € vers ${iban} ?`);
      if(!okConfirm) return;

      const success = await createAccountToAccountTransfer(amount, iban, desc);
      if(success){
        const modal = bootstrap.Modal.getInstance(document.getElementById('transferModal'));
        if(modal) modal.hide();
        document.getElementById('transfer-form').reset();
        renderScheduledQuick();
        computeAndRenderUpcomingBalance();
      }
    });

    // small confirm wrapper using browser confirm to keep code simple
    function confirm(message){ return new Promise(resolve => { resolve(window.confirm(message)); }); }

    // copy IBAN
    document.getElementById('btn-copy-iban').addEventListener('click', async ()=>{
      const val = document.getElementById('acct-iban').value || '';
      if(!val){ showToast('IBAN non disponible', 'warning'); return; }
      try { await navigator.clipboard.writeText(val); showToast('IBAN copié', 'primary'); } catch(e){ const ta=document.createElement('textarea');ta.value=val;document.body.appendChild(ta);ta.select();try{document.execCommand('copy');showToast('IBAN copié','primary')}catch(_){showToast('Impossible de copier','danger')}ta.remove(); }
    });

    // filters
    document.getElementById('tx-filter-type').addEventListener('change', ()=> renderRecentTransactions());
    document.getElementById('tx-filter-q').addEventListener('input', ()=> renderRecentTransactions());
    document.getElementById('tx-filter-clear').addEventListener('click', ()=> { document.getElementById('tx-filter-q').value=''; document.getElementById('tx-filter-type').value='all'; renderRecentTransactions(); });

    // helper: recompute upcoming balance periodically (if scheduled changed)
    setInterval(()=> computeAndRenderUpcomingBalance(), 30*1000);

    window.addEventListener('load', init);

  })();
  </script>
</body>
</html>
