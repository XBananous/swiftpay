<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Swift Pay — Connexion</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">

  <style>
    body { background:#f5f7fb; }
    .card { max-width:720px; margin:40px auto; }
    .logo { font-size:2.25rem; font-weight:700; letter-spacing:0.4px; }
    .small-muted { color: #6c757d; font-size:0.9rem; }
    .separator { display:flex; align-items:center; gap:12px; margin:18px 0; }
    .separator .line { flex:1; height:1px; background:#e9ecef; }
    .rp-badge { font-weight:700; color:#c0392b; margin-left:6px; }
    /* boutons pleine largeur (s'applique aussi via d-grid) */
    .full-width { width:100%; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center mb-4">
          <div class="me-3 text-primary"><i class="fa-solid fa-wallet fa-2x"></i></div>
          <div>
            <div class="logo">Swift Pay</div>
            <div class="small-muted">Connexion</div>
          </div>
        </div>

        <!-- Vues (aucune n'est affichée avant init) -->
        <div id="view-root" aria-live="polite">
          <!-- Loading (affiché par défaut au chargement JS) -->
          <div id="loading-view" class="text-center py-4">
            <div class="spinner-border" role="status" aria-hidden="true"></div>
            <div class="mt-2 small-muted">Chargement de l'authentification et de la base…</div>
          </div>

          <!-- VIEW: Login (identifiant + mot de passe) -->
          <div id="login-view" class="d-none" role="region" aria-label="Connexion">
            <h5>Se connecter</h5>
            <p class="small-muted">Identifiant conseillé : première lettre du prénom + "." + nom (ex. <code>j.durand</code>).</p>

            <div class="mb-3">
              <label for="login_identifier" class="form-label">Identifiant</label>
              <input id="login_identifier" class="form-control" type="text" placeholder="ex. j.durand" autocomplete="username">
            </div>

            <div class="mb-3">
              <label for="login_password" class="form-label">Mot de passe</label>
              <input id="login_password" class="form-control" type="password" placeholder="Ton mot de passe" autocomplete="current-password">
            </div>

            <!-- Bouton connexion pleine largeur -->
            <div class="mb-3 d-grid">
              <button id="btn-login" class="btn btn-primary full-width">
                <i class="fa-solid fa-right-to-bracket me-2" aria-hidden="true"></i> Se connecter
              </button>
            </div>

            <!-- séparateur -->
            <div class="separator" aria-hidden="true">
              <div class="line"></div>
              <div class="small-muted">ou</div>
              <div class="line"></div>
            </div>

            <!-- Bouton créer un compte sous le séparateur, pleine largeur -->
            <div class="mb-3 d-grid">
              <button id="btn-show-create" class="btn btn-outline-secondary full-width">
                <i class="fa-solid fa-user-plus me-2" aria-hidden="true"></i> Créer un compte
              </button>
            </div>

            <div id="login-msg" class="mt-2" role="status"></div>
          </div>

          <!-- VIEW: Create Account -->
          <div id="create-view" class="d-none" role="region" aria-label="Créer un compte">
            <h5>Créer un compte</h5>
            <p class="small-muted">Remplis les champs marqués <span class="rp-badge">rp</span>.</p>

            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Prénom <span class="rp-badge">rp</span></label>
                <input id="first_name" class="form-control" type="text" placeholder="Prénom" autocomplete="given-name">
              </div>
              <div class="col-md-6">
                <label class="form-label">Nom <span class="rp-badge">rp</span></label>
                <input id="last_name" class="form-control" type="text" placeholder="Nom" autocomplete="family-name">
              </div>
              <div class="col-12">
                <label class="form-label">Mot de passe <span class="rp-badge">rp</span></label>
                <input id="create_password" class="form-control" type="password" placeholder="Choisis un mot de passe sécurisé" autocomplete="new-password">
              </div>
              <div class="col-12">
                <label class="form-label">Adresse <span class="rp-badge">rp</span></label>
                <input id="address" class="form-control" type="text" placeholder="Adresse (rue, ville, ... )" autocomplete="street-address">
              </div>
            </div>

            <!-- boutons pleine largeur empilés -->
            <div class="mt-3 d-grid gap-2">
              <button id="btn-create" class="btn btn-success full-width">
                <i class="fa-solid fa-check me-2" aria-hidden="true"></i> Créer et aller à main.html
              </button>
              <button id="btn-cancel-create" class="btn btn-outline-secondary full-width">Annuler</button>
            </div>

            <div id="create-msg" class="mt-2" role="status"></div>
          </div>

          <!-- VIEW: Account (déjà en base) -->
          <div id="account-view" class="d-none" role="region" aria-label="Compte">
            <h5>Compte</h5>
            <div id="account-info" class="mb-3"></div>

            <!-- boutons pleine largeur empilés -->
            <div class="d-grid gap-2">
              <button id="btn-go-main" class="btn btn-primary full-width">Aller à main.html</button>
              <button id="btn-logout" class="btn btn-outline-danger full-width">Se déconnecter</button>
            </div>

            <div id="account-msg" class="mt-2" role="status"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

  <script>
    /************************************************
     * Configuration (fourni)
     ************************************************/
    const SUPABASE_URL = "https://gkzeeytyijerwoeyrhro.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdremVleXR5aWplcndvZXlyaHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMDUzMzIsImV4cCI6MjA3NTY4MTMzMn0.1eUT_gOwsHPYe5GY3K-tmhmB839ki5N0afDG554WfeI";

    // Création du client supabase (immédiate)
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /************************************************
     * Helpers UI
     ************************************************/
    const $ = id => document.getElementById(id);

    // showView affiche UNE vue et cache les autres
    function showView(viewId) {
      const views = ['loading-view','login-view','create-view','account-view'];
      views.forEach(v => {
        const el = $(v);
        if (!el) return;
        if (v === viewId) el.classList.remove('d-none'); else el.classList.add('d-none');
      });
    }

    // Afficher loading par défaut tant que l'initialisation n'a pas eu lieu
    document.addEventListener('DOMContentLoaded', () => {
      // Montrer explicitement loading dès le chargement du DOM
      showView('loading-view');
      attachHandlers();
      // initialisation asynchrone de l'état d'authentification
      initAuthState();
    });

    function attachHandlers(){
      $('btn-login').addEventListener('click', onLogin);
      $('btn-show-create').addEventListener('click', () => { showView('create-view'); });
      $('btn-cancel-create').addEventListener('click', () => { showView('login-view'); });
      $('btn-create').addEventListener('click', onCreate);
      $('btn-go-main')?.addEventListener('click', () => { window.location.href = 'main.html'; });
      $('btn-logout')?.addEventListener('click', onSignOut);
    }

    /************************************************
     * Auth / session init
     * onAuthStateChange et getSession : on attend la fin
     ************************************************/
    async function initAuthState(){
      showView('loading-view');
      try {
        // Récupère session existante (si l'utilisateur est déjà connecté)
        const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
        if (sessionError) console.warn('getSession error:', sessionError);
        const session = sessionData?.session ?? null;

        // Ecoute les changements d'authentification (utile si login / signUp modifie l'état)
        supabase.auth.onAuthStateChange((event, session) => {
          if (session?.user) {
            checkAccountForUser(session.user);
          } else {
            // si déconnecté -> afficher l'écran de connexion
            showView('login-view');
          }
        });

        if (session && session.user) {
          // utilisateur connecté -> vérifier la table accounts
          await checkAccountForUser(session.user);
        } else {
          // pas connecté -> afficher login
          showView('login-view');
        }

      } catch(err) {
        console.error('initAuthState error', err);
        $('login-msg').innerHTML = `<div class="text-danger">Erreur initialisation : ${err.message || err}</div>`;
        showView('login-view');
      }
    }

    /************************************************
     * Connexion / Création (identifiant -> email synthétique)
     ************************************************/
    function synthEmailFromIdentifier(identifier){
      const safe = (identifier || '').trim().toLowerCase();
      return safe + '@swiftpay.local';
    }

    async function onLogin(){
      $('login-msg').innerHTML = '';
      const identifier = $('login_identifier').value.trim();
      const password = $('login_password').value;

      if (!identifier || !password) {
        $('login-msg').innerHTML = '<div class="text-danger">Identifiant et mot de passe requis.</div>';
        return;
      }

      showView('loading-view');
      try {
        const email = synthEmailFromIdentifier(identifier);
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });

        if (error) throw error;

        // Si authentifié, checkAccountForUser sera déclenché par onAuthStateChange ou ici :
        if (data?.user) {
          await checkAccountForUser(data.user);
        } else {
          // fallback
          showView('login-view');
          $('login-msg').innerHTML = '<div class="text-success">Connecté.</div>';
        }
      } catch(err) {
        console.error('onLogin error', err);
        showView('login-view');
        $('login-msg').innerHTML = `<div class="text-danger">Erreur connexion : ${err.message || err}</div>`;
      }
    }

    async function onCreate(){
      $('create-msg').innerHTML = '';
      const first_name = $('first_name').value.trim();
      const last_name = $('last_name').value.trim();
      const password = $('create_password').value;
      const address = $('address').value.trim();

      // rp requis : prénom, nom, adresse et mot de passe
      if(!first_name || !last_name || !password || !address){
        $('create-msg').innerHTML = '<div class="text-danger">Tous les champs marqués rp sont requis.</div>';
        return;
      }

      // construire identifiant conseillé (initiale.prenom + nom)
      const identifier = (first_name[0] || '').toLowerCase() + '.' + last_name.toLowerCase();
      const email = synthEmailFromIdentifier(identifier);

      showView('loading-view');
      try {
        // Créer utilisateur dans Supabase Auth
        const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
          email,
          password
        });

        if (signUpError) throw signUpError;

        // Insérer dans la table accounts
        const payload = {
          user_id: signUpData.user?.id || null,
          identifier,
          email,
          first_name,
          last_name,
          address,
          created_at: new Date().toISOString()
        };

        const { data: inserted, error: insertError } = await supabase.from('accounts').insert([payload]).select().single();
        if (insertError) throw insertError;

        // redirige vers main.html
        window.location.href = 'main.html';
      } catch(err) {
        console.error('onCreate error', err);
        showView('create-view');
        $('create-msg').innerHTML = `<div class="text-danger">Erreur création : ${err.message || err}</div>`;
      }
    }

    /************************************************
     * Vérifier la table accounts pour l'utilisateur
     ************************************************/
    async function checkAccountForUser(user){
      showView('loading-view');
      $('account-msg').innerHTML = '';

      try {
        const userId = user.id;
        const email = user.email;

        // recherche par user_id OU email
        const { data, error } = await supabase
          .from('accounts')
          .select('*')
          .or(`user_id.eq.${userId},email.eq.${email}`)
          .limit(1);

        if (error) {
          console.error('checkAccountForUser select error', error);
          $('account-msg').innerHTML = `<div class="text-danger">Erreur lecture comptes : ${error.message}</div>`;
          showView('account-view');
          return;
        }

        if (data && data.length > 0) {
          renderAccountView(data[0]);
        } else {
          // pas trouvé -> proposer création (pré-remplir email interne visible dans message)
          $('create-msg').innerHTML = `<div class="small-muted">Compte introuvable pour ${escapeHtml(email)} — tu peux en créer un.</div>`;
          showView('create-view');
        }
      } catch(err) {
        console.error('checkAccountForUser error', err);
        $('account-msg').innerHTML = `<div class="text-danger">Erreur : ${err.message || err}</div>`;
        showView('account-view');
      }
    }

    function renderAccountView(acct){
      const infoHtml = `
        <div class="border rounded p-3 mb-2">
          <div><strong>Identifiant :</strong> ${escapeHtml(acct.identifier || '')}</div>
          <div><strong>Prénom :</strong> ${escapeHtml(acct.first_name || '')}</div>
          <div><strong>Nom :</strong> ${escapeHtml(acct.last_name || '')}</div>
          <div><strong>E-mail (interne) :</strong> ${escapeHtml(acct.email || '')}</div>
          <div><strong>Adresse :</strong> ${escapeHtml(acct.address || '—')}</div>
        </div>`;
      $('account-info').innerHTML = infoHtml;
      showView('account-view');
    }

    async function onSignOut(){
      await supabase.auth.signOut();
      showView('login-view');
      $('login-msg').innerHTML = '<div class="small-muted">Déconnecté.</div>';
    }

    function escapeHtml(str){
      if(!str) return '';
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }
  </script>
</body>
</html>
